name: Deploy Web Scraper to AWS Lambda

on:
  push:
    branches:
      - main
      - pavan
  pull_request:
    branches:
      - main
      - pavan
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AWS_REGION: ap-south-1
  PROJECT_NAME: web-scraper
  ECR_REPOSITORY: web-scraper-repo
  LAMBDA_FUNCTION_NAME: web-scraper-function
  STACK_NAME: web-scraper-stack

jobs:
  deploy:
    name: Deploy to AWS Lambda
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.run_id }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get commit SHA (short)
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.vars.outputs.sha_short }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Push Docker image to ECR
        if: github.event_name != 'pull_request'
        run: |
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.vars.outputs.sha_short }}
      
      - name: Verify image in ECR
        if: github.event_name != 'pull_request'
        run: |
          echo "Verifying image exists in ECR..."
          aws ecr describe-images \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --image-ids imageTag=latest \
            --region ${{ env.AWS_REGION }}
          echo "Image verified successfully"

      - name: Deploy CloudFormation stack
        if: github.event_name != 'pull_request'
        run: |
          aws cloudformation deploy \
            --template-file cloudformation-template.yaml \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --parameter-overrides \
              ProjectName=${{ env.PROJECT_NAME }} \
              LambdaMemorySize=3008 \
              LambdaTimeout=900 \
              EphemeralStorageSize=2048 \
            --capabilities CAPABILITY_NAMED_IAM \
            --tags Project=${{ env.PROJECT_NAME }} GitHubRepo=${{ github.repository }}

      - name: Update Lambda function
        if: github.event_name != 'pull_request'
        run: |
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --image-uri ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest \
            --region ${{ env.AWS_REGION }}

      - name: Wait for Lambda update to complete
        if: github.event_name != 'pull_request'
        run: |
          aws lambda wait function-updated \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Get deployment info
        if: github.event_name != 'pull_request'
        id: deployment-info
        run: |
          FUNCTION_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query "Stacks[0].Outputs[?OutputKey=='FunctionUrlEndpoint'].OutputValue" \
            --output text)
          
          S3_BUCKET=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query "Stacks[0].Outputs[?OutputKey=='S3BucketName'].OutputValue" \
            --output text)
          
          echo "function_url=$FUNCTION_URL" >> $GITHUB_OUTPUT
          echo "s3_bucket=$S3_BUCKET" >> $GITHUB_OUTPUT

      - name: Test Lambda function
        if: github.event_name != 'pull_request'
        continue-on-error: true
        run: |
          echo "Testing Lambda function..."
          aws lambda invoke \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --invocation-type Event \
            --payload '{}' \
            response.json
          
          echo "Lambda invoked asynchronously. Check CloudWatch Logs for execution details."

      - name: Deployment Summary
        if: github.event_name != 'pull_request'
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployed Resources" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Stack Name**: ${{ env.STACK_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Lambda Function**: ${{ env.LAMBDA_FUNCTION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ECR Repository**: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Image Tag**: latest, ${{ steps.vars.outputs.sha_short }}" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: ${{ steps.deployment-info.outputs.s3_bucket }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Function URL**: ${{ steps.deployment-info.outputs.function_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Commands" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Invoke function" >> $GITHUB_STEP_SUMMARY
          echo "aws lambda invoke --function-name ${{ env.LAMBDA_FUNCTION_NAME }} --region ${{ env.AWS_REGION }} response.json" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check logs" >> $GITHUB_STEP_SUMMARY
          echo "aws logs tail /aws/lambda/${{ env.LAMBDA_FUNCTION_NAME }} --follow --region ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# List scraped data" >> $GITHUB_STEP_SUMMARY
          echo "aws s3 ls s3://${{ steps.deployment-info.outputs.s3_bucket }}/ --region ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Docker build successful! Image is ready for deployment once PR is merged.'
            })
